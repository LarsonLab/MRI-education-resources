

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>The MRI Signal Equation and K-space &#8212; Principles of MRI</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-51903906-1"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-51903906-1');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'MRI Signal Equation';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Artifacts" href="Artifacts.html" />
    <link rel="prev" title="Field of View (FOV) and Resolution" href="FOV%20and%20Resolution.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="Introduction.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/HPBrain-Anime.png" class="logo__image only-light" alt="Principles of MRI - Home"/>
    <script>document.write(`<img src="_static/HPBrain-Anime.png" class="logo__image only-dark" alt="Principles of MRI - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Introduction.html">
                    Introduction to Principles of MRI
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Magnetic Resonance Physics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="MRI%20System.html">The MRI System</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spin%20Physics.html">Spin Physics</a></li>
<li class="toctree-l1"><a class="reference internal" href="MR%20Physics%20-%20Bloch%20Equation.html">Bloch Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Magnetic%20Fields%20and%20RF%20Coils.html">Magnetic fields in MRI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MR Experiment</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Pulse%20Sequence.html">The Pulse Sequence</a></li>
<li class="toctree-l1"><a class="reference internal" href="Gradient%20and%20Spin%20Echoes.html">Gradient and Spin Echo Pulse Sequences</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRI%20Contrast.html">MRI Contrast</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Image Formation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Spatial%20Encoding.html">Spatial Encoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="Image%20Reconstruction.html">Image Reconstruction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Image Characteristics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Signal%20to%20Noise%20Ratio.html">Signal to Noise Ratio (SNR)</a></li>

<li class="toctree-l1"><a class="reference internal" href="FOV%20and%20Resolution.html">Field of View (FOV) and Resolution</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">The MRI Signal Equation and K-space</a></li>
<li class="toctree-l1"><a class="reference internal" href="Artifacts.html">Artifacts</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Radiofrequency Pulses</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="RF%20Pulses.html">RF Pulses</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spectral-Spatial%20RF%20Pulses.html">Spectral-Spatial RF Pulses</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fun%20with%20RF%20Pulses.html">Fun with RF Pulses?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Fast Imaging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fast%20Imaging%20Pulse%20Sequences.html">Fast Imaging Pulse Sequences</a></li>
<li class="toctree-l1"><a class="reference internal" href="Accelerated%20Imaging%20Methods.html">Accelerated Imaging Methods</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference Material</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="MRI%20Notation.html">MRI Notation and Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRI%20Math%20Concepts.html">MRI Math Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="Software_Resources.html">MRI Software Resources</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/larsonlab/MRI-education-resources" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/larsonlab/MRI-education-resources/issues/new?title=Issue%20on%20page%20%2FMRI Signal Equation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/MRI Signal Equation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>The MRI Signal Equation and K-space</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#idealized-signal-equation">Idealized Signal Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-coil-sensitivity">Adding Coil Sensitivity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relaxation-during-signal-acquisition">Relaxation during signal acquisition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#off-resonance-and-chemical-shift">Off-resonance and Chemical Shift</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-signal-equation">Complete Signal Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#k-space-data-weighting">K-space Data Weighting</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-octave notranslate"><div class="highlight"><pre><span></span><span class="c">% setup MRI-education-resources path and requirements</span>
<span class="n">cd</span> <span class="p">.</span><span class="o">./</span>
<span class="n">startup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>warning: using the gnuplot graphics toolkit is discouraged

The gnuplot graphics toolkit is not actively maintained and has a number
of limitations that are ulikely to be fixed.  Communication with gnuplot
uses a one-directional pipe and limited information is passed back to the
Octave interpreter so most changes made interactively in the plot window
will not be reflected in the graphics properties managed by Octave.  For
example, if the plot window is closed with a mouse click, Octave will not
be notified and will not update it&#39;s internal list of open figure windows.
We recommend using the qt toolkit instead.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loading image
loading signal
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="the-mri-signal-equation-and-k-space">
<h1>The MRI Signal Equation and K-space<a class="headerlink" href="#the-mri-signal-equation-and-k-space" title="Permalink to this heading">#</a></h1>
<p>The MRI signal equation can be used to understand how images are formed as well as the influence of other factors on contrast, image quality and artifacts.  It is derived from the Bloch equation, without any RF pulses being applied.  The signal equation can be greatly simplified to understand image formation, but can include additional effects to understand more complex behavior.  Here we start with the simplified, idealized signal equiation, and build up a full MRI signal equation.</p>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Describe how images are formed</p>
<ul class="simple">
<li><p>Describe the effects of gradients on the signal</p></li>
<li><p>What is the impact of relaxation and off-resonance/chemical shift on the signal</p></li>
</ul>
</li>
<li><p>Understand the constraints and tradeoffs in MRI</p>
<ul class="simple">
<li><p>How do relaxation and off-resonance/chemical shift limit the readout duration</p></li>
</ul>
</li>
<li><p>Manipulate MRI sequence parameters to improve performance</p>
<ul class="simple">
<li><p>How does the readout duration affect artifacts due to relaxation and off-resonnace/chemical shift</p></li>
</ul>
</li>
<li><p>Identify artifacts and how to mitigate them</p>
<ul class="simple">
<li><p>What is the effect of relaxation and off-resonnace/chemical shift during the readout on the resulting images</p></li>
</ul>
</li>
</ol>
</section>
<section id="idealized-signal-equation">
<h2>Idealized Signal Equation<a class="headerlink" href="#idealized-signal-equation" title="Permalink to this heading">#</a></h2>
<p>Combining the effects of magnetic field gradients and the principles of the MRI signal, we obtain the following idealized signal equation:</p>
<div class="math notranslate nohighlight">
\[s(t) = \int m(\vec{r}) \  \exp\left( -i \gamma \int_0^t \vec{G}(\tau) \cdot \vec{r} \ d\tau \right) \  d\vec{r}\]</div>
<p>using the notation <span class="math notranslate nohighlight">\(m(\vec{r}) = M_{XY}(\vec{r}, t=0)\)</span> for the initial transverse magnetization for reasons that will become clear soon.</p>
<p>In many situations, an idealized signal equation is useful, particularly for understanding image formation.  The idealized signal equation neglects relaxation, RF coil profile, and off-resonance, but we will add them in later.</p>
<p>This is simplified using the concept of k-space:</p>
<div class="math notranslate nohighlight">
\[s(t) = \int m(\vec{r})\  e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r}\]</div>
<p>From this idealized formulation, it is easiest to see that the signal is the Fourier Transform of the transverse magnetization in the subject:</p>
<div class="math notranslate nohighlight">
\[s(t) = \mathcal{F}\{m(\vec{r}) \} |_{\vec{k} = \vec{k}(t)}\]</div>
<p>Simplified using the notation <span class="math notranslate nohighlight">\(M(\vec{k}) = \mathcal{F}\{m(\vec{r}) \}\)</span> as</p>
<div class="math notranslate nohighlight">
\[s(t) = M(\vec{k}(t))\]</div>
<p>The is a key result in image formation, showing that our signal represents the Fourier Transform, meaning that an inverse Fourier Transform will be used for image reconstruction from MRI signals.</p>
</section>
<section id="adding-coil-sensitivity">
<h2>Adding Coil Sensitivity<a class="headerlink" href="#adding-coil-sensitivity" title="Permalink to this heading">#</a></h2>
<p>From the idealized signal equation, the RF coil receive profile simply modulates the transverse magnetization, and the received signal for coil element <span class="math notranslate nohighlight">\(n\)</span>, which has a coil sensitivity profile <span class="math notranslate nohighlight">\(C_n(\vec{r})\)</span>, is</p>
<div class="math notranslate nohighlight">
\[s_n(t) = \int m(\vec{r})\ C_n(\vec{r})\ e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r}\]</div>
<p>And the signal is once again the Fourier Transform of the object, but now multiplied by the coil sensitivity:</p>
<div class="math notranslate nohighlight">
\[s_n(t) = \mathcal{F}\{m(\vec{r}) \ C_n(\vec{r}) \} |_{\vec{k} = \vec{k}(t)}\]</div>
</section>
<section id="relaxation-during-signal-acquisition">
<h2>Relaxation during signal acquisition<a class="headerlink" href="#relaxation-during-signal-acquisition" title="Permalink to this heading">#</a></h2>
<p>Starting with the idealized signal equation, we can add in relaxation, which modulates the receieved signal over time.  This will create some type of weighting in k-space, which leads to image filtering (often blurring).  This weighting is spatially varying, depending on relaxation of different tissues.</p>
<!-- $$s(t) = \int m(\vec{r}) \ e^{-t/T_2^*(\vec{r})}\  \exp\left( -i \gamma \int_0^t \vec{G}(\tau) \cdot \vec{r} d\tau \right) \  d\vec{r}$$ -->
<div class="math notranslate nohighlight">
\[s(t) = \int m(\vec{r})\ e^{-t/T_2^*(\vec{r})}\  e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r}\]</div>
<p>To interpret the effect of relaxation, consider a single value of <span class="math notranslate nohighlight">\(T_2^*(\vec{r}) = T_2^*\)</span>, in which case this can be removed from the integral and</p>
<div class="math notranslate nohighlight">
\[\begin{split}s(t) = e^{-t/T_2^*} \int m(\vec{r})\ e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r} \\
 = M(\vec{k}(t))\  e^{-t/T_2^*} \end{split}\]</div>
<p>From this, we can see that relaxation leads to signal amplitude modulation as we acquire data across k-space.  To see the effect on image formation, we determine the function <span class="math notranslate nohighlight">\(\upsilon (\vec{k})\)</span> which captures across k-space trajectory in time and across all TRs to characterize this modulation:</p>
<div class="math notranslate nohighlight">
\[\hat{M}(\vec{k}) = M(\vec{k}) e^{- \upsilon(\vec{k}) / T_2^*}\]</div>
<p>Examples of <span class="math notranslate nohighlight">\(\upsilon(\vec{k})\)</span> are shown below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-octave notranslate"><div class="highlight"><pre><span></span><span class="c">% Example of k-space trajectory time weighting functions, upsilon</span>

<span class="c">% Cartesian</span>

<span class="c">% kx(t)  = gammabar Gxr (t-TE)</span>
<span class="c">% upsilon(k) = t = kx/gamma*Gxr + TE</span>

<span class="nb">gamma</span> <span class="p">=</span> <span class="mf">42.58</span><span class="p">;</span> <span class="c">%kHz/mT</span>
<span class="n">N</span> <span class="p">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="n">dt</span> <span class="p">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="c">% ms</span>
<span class="n">TE</span> <span class="p">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c">% ms</span>
<span class="n">t</span> <span class="p">=</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="p">;</span>

<span class="n">Gxr</span> <span class="p">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="nb">gamma</span><span class="p">);</span>

<span class="n">kx0</span> <span class="p">=</span> <span class="nb">gamma</span><span class="o">*</span><span class="n">Gxr</span><span class="o">*</span> <span class="n">t</span><span class="p">;</span>
<span class="p">[</span><span class="n">kx</span> <span class="n">ky</span><span class="p">]</span> <span class="p">=</span> <span class="nb">meshgrid</span><span class="p">(</span><span class="n">kx0</span><span class="p">,</span><span class="n">kx0</span><span class="p">);</span>

<span class="n">upsilon_Cartesian</span> <span class="p">=</span> <span class="n">kx</span> <span class="o">/</span> <span class="p">(</span><span class="nb">gamma</span><span class="o">*</span><span class="n">Gxr</span><span class="p">)</span> <span class="o">+</span> <span class="n">TE</span><span class="p">;</span> 

<span class="c">% more simply, upsilon is time to readout single line of k-space</span>
<span class="c">%upsilon = repmat(t + TE, [1 N]);</span>

<span class="nb">figure</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">upsilon_Cartesian</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;k_x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;k_y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Cartesian time weighting, \upsilon(k)&#39;</span><span class="p">)</span>

<span class="c">% EPI</span>

<span class="c">% add ky weighting as</span>
<span class="c">% ky(t) = tesp * dky</span>
<span class="n">tesp</span> <span class="p">=</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="p">;</span> <span class="c">% simplified, assuming no deadtime between ky lines</span>
<span class="n">TE</span> <span class="p">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">tesp</span><span class="o">*</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="c">% time for all data acquisition</span>
<span class="n">tall</span> <span class="p">=</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span>^<span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span>^<span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">TE</span><span class="p">;</span>

<span class="n">upsilon_EPI</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">tall</span><span class="p">,</span> <span class="p">[</span><span class="n">N</span> <span class="n">N</span><span class="p">]).</span><span class="o">&#39;</span><span class="p">;</span> 

<span class="nb">figure</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">upsilon_EPI</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;k_x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;k_y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Echo-planar time weighting, \upsilon(k)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/04e32389def1da9556efd712d119655989abaa4ab970ce8cc166a8125b4a22c0.png" src="_images/04e32389def1da9556efd712d119655989abaa4ab970ce8cc166a8125b4a22c0.png" />
<img alt="_images/92ac396d1094116faca36e071635f22ff14da490df79aa5b1e645af612d2ec53.png" src="_images/92ac396d1094116faca36e071635f22ff14da490df79aa5b1e645af612d2ec53.png" />
</div>
</div>
<p>Thus the reconstructed image will corrupted by a convolution (denoted by <span class="math notranslate nohighlight">\(*\)</span>) based on the k-space amplitude weighting</p>
<div class="math notranslate nohighlight">
\[\hat{m}(\vec{r}) = \mathcal{F}^{-1} \{ \hat{M}(\vec{k})\} = m(\vec{r}) * \mathcal{F}^{-1} \{ e^{-\upsilon(\vec{k})/  T_2^*} \}\]</div>
<p>This convolution can result in blurring (low-pass filtering) for center-out type trajectories, or high-pass filtering (e.g. edge enhancement but overall SNR loss) when starting at the edge of k-space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-octave notranslate"><div class="highlight"><pre><span></span><span class="c">% Convolution kernels for T2* weighting</span>

<span class="n">T2s</span> <span class="p">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c">% ms</span>

<span class="n">W_Cartesian</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">upsilon_Cartesian</span><span class="o">/</span><span class="n">T2s</span><span class="p">));</span>
<span class="n">W_EPI</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">upsilon_EPI</span><span class="o">/</span><span class="n">T2s</span><span class="p">));</span>

<span class="n">x0</span> <span class="p">=</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="p">[</span><span class="n">x</span> <span class="n">y</span> <span class="p">]</span> <span class="p">=</span> <span class="nb">meshgrid</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x0</span><span class="p">);</span>
<span class="nb">figure</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_Cartesian</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;k_x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;k_y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;Cartesian convolution kernel, T_2^* =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">T2s</span><span class="p">)</span> <span class="s">&#39; ms&#39;</span><span class="p">])</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_EPI</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;k_x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;k_y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;EPI convolution kernel, T_2^* =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">T2s</span><span class="p">)</span> <span class="s">&#39; ms&#39;</span><span class="p">])</span>

<span class="n">T2s</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c">% ms</span>

<span class="n">W_Cartesian</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">upsilon_Cartesian</span><span class="o">/</span><span class="n">T2s</span><span class="p">));</span>
<span class="n">W_EPI</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">upsilon_EPI</span><span class="o">/</span><span class="n">T2s</span><span class="p">));</span>

<span class="nb">figure</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_Cartesian</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;Cartesian convolution kernel, T_2^* =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">T2s</span><span class="p">)</span> <span class="s">&#39; ms&#39;</span><span class="p">])</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_EPI</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;EPI convolution kernel, T_2^* =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">T2s</span><span class="p">)</span> <span class="s">&#39; ms&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c2bc6f3fee2a679d68cb3956f1dd71771107c64c4330c26801b306718311c22e.png" src="_images/c2bc6f3fee2a679d68cb3956f1dd71771107c64c4330c26801b306718311c22e.png" />
<img alt="_images/2ac77f1e3c485944eb84049be4e604109e3623a5e7fef06e080c1bd6acd6f1e0.png" src="_images/2ac77f1e3c485944eb84049be4e604109e3623a5e7fef06e080c1bd6acd6f1e0.png" />
</div>
</div>
<p>In the above plots, the height of the main peak in the center represents the expected SNR, including losses due to blurring, while the signal amplitude outside of the main peak represents blurring that will occur.   These show that the blurring and signal loss from <span class="math notranslate nohighlight">\(T_2^*\)</span> gets worse as the relaxation time is shorter, the blurring it is much worse for EPI (in phase encoding direction) versus Cartesian trajectories.</p>
</section>
<section id="off-resonance-and-chemical-shift">
<h2>Off-resonance and Chemical Shift<a class="headerlink" href="#off-resonance-and-chemical-shift" title="Permalink to this heading">#</a></h2>
<p>Off-resonance and chemical shift lead to changes in the precession frequency of the magnetization.  We can add this onto the idealized signal equation.</p>
<p>Here we separately define:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta f_r(\vec{r}) = \bar \gamma \Delta B_0(\vec{r})\)</span> - magnetic field inhomogeneities, including main field imperfections, and magnetic susceptibility effects</p></li>
<li><p><span class="math notranslate nohighlight">\(\Delta f_{cs}\)</span> - frequency changes due to chemical shift, so depends on the chemical species being examined (could sum or index signal over this dimension)</p></li>
</ul>
<!-- $$s(t) = \int m(\vec{r})\ e^{-i 2 \pi \Delta f_{cs} t} e^{-i 2 \pi \Delta f_r(\vec{r}) t} e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r}$$ -->
<p>For simplicity, combine all off-resonance and/or chemical shift into a single frequnecy shift term, <span class="math notranslate nohighlight">\(\Delta f(\vec{r}) = \Delta f_{cs} + \Delta f_r(\vec{r})\)</span> as</p>
<div class="math notranslate nohighlight">
\[s(t) = \int m(\vec{r})\ e^{-i 2 \pi \Delta f(\vec{r}) t} e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r}\]</div>
<p>Solving for the effect of frequency shifts then requires specific knowledge of the k-space trajectory, and the interaction of a spatially varying field further complicates this effect.  However, some intuition can be gained by assuming a single frequency shift, <span class="math notranslate nohighlight">\(\Delta f(\vec{r}) = \Delta f_0\)</span>, which can then be removed from the integral as</p>
<div class="math notranslate nohighlight">
\[\begin{split}s(t) = e^{-i 2 \pi \Delta f_0 t} \int m(\vec{r})\ e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r} \\
 = M(\vec{k}(t))\  e^{-i 2 \pi \Delta f_0 t} \end{split}\]</div>
<p>From this, we can see that the frequency shift leads to a phase accumulation as we acquire data across k-space.  To see the effect on image formation, we determine the function <span class="math notranslate nohighlight">\(\upsilon (\vec{k})\)</span> which captures across k-space trajectory in time and across all TRs to characterize this phase accumulation:</p>
<div class="math notranslate nohighlight">
\[\hat{M}(\vec{k}) = M(\vec{k}) e^{-i 2 \pi\ \upsilon(\vec{k}) \Delta f_0}\]</div>
<p>Thus the reconstructed image will corrupted by a convolution based on the k-space phase accumulation</p>
<div class="math notranslate nohighlight">
\[\hat{m}(\vec{r}) = \mathcal{F}^{-1} \{ \hat{M}(\vec{k})\} = m(\vec{r}) * \mathcal{F}^{-1} \{ e^{-i 2 \pi\ \upsilon(\vec{k}) \Delta f_0} \}\]</div>
<p>This convolution results in a shift for Cartesian and echo-planar sampling, and blurring for spiral and radial sampling.</p>
<p>This analysis can also be applied to look at the effect from off-resonance at a single location, <span class="math notranslate nohighlight">\(\vec{r} = \vec{r}_0\)</span>
$<span class="math notranslate nohighlight">\(s_{r_0}(t) = \mathcal{F}\{m(\vec{r}_0) \} |_{\vec{k} = \vec{k}(t)}  e^{-i 2 \pi \Delta f(\vec{r}_0) t} \)</span>$</p>
<div class="math notranslate nohighlight">
\[\hat{m}(\vec{r}_0) = m(\vec{r}_0) \star \mathcal{F}^{-1} \{ e^{-i 2 \pi\ \upsilon(\vec{k}) \Delta f(\vec{r}_0)} \}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-octave notranslate"><div class="highlight"><pre><span></span><span class="c">% Convolution kernels for off-resonance weighting</span>

<span class="n">df</span> <span class="p">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">tesp</span><span class="p">);</span> <span class="c">% kHz</span>

<span class="n">W_Cartesian</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">*</span><span class="n">df</span><span class="o">*</span><span class="n">upsilon_Cartesian</span><span class="p">));</span>
<span class="n">W_EPI</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">*</span><span class="n">df</span><span class="o">*</span><span class="n">upsilon_EPI</span><span class="p">));</span>

<span class="n">x0</span> <span class="p">=</span> <span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<span class="p">[</span><span class="n">x</span> <span class="n">y</span> <span class="p">]</span> <span class="p">=</span> <span class="nb">meshgrid</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x0</span><span class="p">);</span>
<span class="nb">figure</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_Cartesian</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;k_x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;k_y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;Cartesian convolution kernel, \Delta f =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span> <span class="s">&#39; Hz&#39;</span><span class="p">])</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_EPI</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;k_x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;k_y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;EPI convolution kernel, \Delta f=&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span> <span class="s">&#39; Hz&#39;</span><span class="p">])</span>

<span class="n">df</span> <span class="p">=</span> <span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">tesp</span><span class="p">);</span> <span class="c">% kHz</span>

<span class="n">W_Cartesian</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">*</span><span class="n">df</span><span class="o">*</span><span class="n">upsilon_Cartesian</span><span class="p">));</span>
<span class="n">W_EPI</span> <span class="p">=</span> <span class="n">ifft2c</span><span class="p">(</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">*</span><span class="n">df</span><span class="o">*</span><span class="n">upsilon_EPI</span><span class="p">));</span>

<span class="nb">figure</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_Cartesian</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;Cartesian convolution kernel, \Delta f =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span> <span class="s">&#39; Hz&#39;</span><span class="p">])</span>
<span class="nb">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="nb">mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">W_EPI</span><span class="p">))</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">),</span> <span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">([</span><span class="s">&#39;EPI convolution kernel, \Delta f =&#39;</span> <span class="n">int2str</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span> <span class="s">&#39; Hz&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7116ed83d8359b6883a12abf711538b5c0ffc32e612333da3dc4050edb5f88f6.png" src="_images/7116ed83d8359b6883a12abf711538b5c0ffc32e612333da3dc4050edb5f88f6.png" />
<img alt="_images/8f6a3cbbd80b72ee00d3a30c540d68b3fd29709b58d9cb727045d05a021c1418.png" src="_images/8f6a3cbbd80b72ee00d3a30c540d68b3fd29709b58d9cb727045d05a021c1418.png" />
</div>
</div>
<p>For frequency shift, the main peak of the convolution kernels is shifted frfom the origin.  This will result in a shift in the reconstructed image.  The shift is much larger for EPI and is in the phase encoding instead of the frequency encoding direction.  (The residual side lobes are due to sinc interpolation effects, similar to Gibbs ringing.)</p>
</section>
<section id="complete-signal-equation">
<h2>Complete Signal Equation<a class="headerlink" href="#complete-signal-equation" title="Permalink to this heading">#</a></h2>
<p>Finally, we can write the most intimidating version, a full version of signal equation, including relaxation, coil sensitivity, off-resonance and chemical shift, and gradients.
The signal from an individual RF coil element <span class="math notranslate nohighlight">\(n\)</span> is</p>
<div class="math notranslate nohighlight">
\[s_n(t) = \int m(\vec{r})\ C_n(\vec{r})\ e^{-t/T_2^*(\vec{r})}\ e^{-i 2 \pi \Delta f_{cs} t} e^{-i 2 \pi \Delta f_r(\vec{r}) t} \  \exp\left( -i \gamma \int_0^t \vec{G}(\tau) \cdot \vec{r} \ d\tau \right) \  d\vec{r}\]</div>
<p>which is typically simplified for understanding image formation using k-space:</p>
<div class="math notranslate nohighlight">
\[s_n(t) = \int m(\vec{r})\ C_n(\vec{r})\ e^{-t/T_2^*(\vec{r})}\ e^{-i 2 \pi \Delta f_{cs} t} e^{-i 2 \pi \Delta f_r(\vec{r}) t} \  e^{-i 2 \pi \vec{k}(t) \cdot \vec{r}} \  d\vec{r}\]</div>
<p>Note that this describes the signal behavior between RF pulses.  Incorporating RF pulses can be done either through rotation matrices or some solution of the Bloch equation such as numerical solvers or phase graphs.</p>
</section>
<section id="k-space-data-weighting">
<h2>K-space Data Weighting<a class="headerlink" href="#k-space-data-weighting" title="Permalink to this heading">#</a></h2>
<p>As shown in the relaxation and frequency shift cases above, a powerful framework for characterizing their effects is to define a k-space weighting that determines the signal modulation.  Expressing this generally, define a weighting function
<span class="math notranslate nohighlight">\(W(\vec{k})\)</span> that can be complex valued and capture amplitude and phase modulations.  Then,</p>
<div class="math notranslate nohighlight">
\[\hat{M}(\vec{k}) = M(\vec{k}) W(\vec{k}) \]</div>
<div class="math notranslate nohighlight">
\[\hat{m}(\vec{r}) = m(\vec{r}) * \mathcal{F}^{-1} \{ W(\vec{k}) \} = m(\vec{r}) * w(\vec{r})\]</div>
<p>Where <span class="math notranslate nohighlight">\(w(\vec{r})\)</span> is the inverse Fourier Transform of the weighting function.  This is also known as a point spread function (PSF) or impulse response function.  Thus the effects can be boiled down to a convolution operation in the resulting reconstructed image.</p>
<p>When the frequency shift and relaxation rates vary across space, it is helpful to decompose the image into components, <span class="math notranslate nohighlight">\(m_i\)</span> that experience the same weighting (e.g. same frequency shift, or same <span class="math notranslate nohighlight">\(T_2^*\)</span>) <span class="math notranslate nohighlight">\(W_i\)</span>.</p>
<div class="math notranslate nohighlight">
\[ m(\vec{r}) = \sum_i m_i(\vec{r}) \]</div>
<p>Since the Fourier Transform is linear,</p>
<div class="math notranslate nohighlight">
\[\hat{M}(\vec{k}) = \sum_i M_i(\vec{k}) W_i(\vec{k}) \]</div>
<div class="math notranslate nohighlight">
\[\hat{m}(\vec{r}) =\sum_i m_i(\vec{r}) * w_i(\vec{r})\]</div>
<p>So each component is convolved with its own convolution kernel.  For example, to analyze chemical shift we can divide our image up into water, <span class="math notranslate nohighlight">\(m_1(\vec{r})\)</span>, and fat, <span class="math notranslate nohighlight">\(m_2(\vec{r})\)</span>, components, then <span class="math notranslate nohighlight">\(W_1(\vec{k}) = 1\)</span>, <span class="math notranslate nohighlight">\(W_2(\vec{k}) = e^{-i 2 \pi\ \upsilon(\vec{k}) \Delta f_{fat}}\)</span>, and the resulting image will be</p>
<div class="math notranslate nohighlight">
\[\hat{m}(\vec{r}) = m_1(\vec{r}) + m_2(\vec{r}) * w_2(\vec{r})\]</div>
<p>providing an accurate image of thw water component but some corrupted fat image (typically shifted in space for Cartesian trajectories).</p>
<p>The k-space data weighting concept is very powerful.  It can include frequency shifts. It can include weighting from all types of relaxation (<span class="math notranslate nohighlight">\(T_1, T_2, T_2^*\)</span>) from more complex acquisition strategies such as SSFP and fast spin-echos.  It can include diffusion-weighting, flow effects, and more.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "octave"
        },
        kernelOptions: {
            name: "octave",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'octave'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="FOV%20and%20Resolution.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Field of View (FOV) and Resolution</p>
      </div>
    </a>
    <a class="right-next"
       href="Artifacts.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Artifacts</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#idealized-signal-equation">Idealized Signal Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-coil-sensitivity">Adding Coil Sensitivity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relaxation-during-signal-acquisition">Relaxation during signal acquisition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#off-resonance-and-chemical-shift">Off-resonance and Chemical Shift</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-signal-equation">Complete Signal Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#k-space-data-weighting">K-space Data Weighting</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Peder Larson
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  Citation - DOI <a href="https://doi.org/10.5281/zenodo.5547020">10.5281/zenodo.5547020</a>
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>